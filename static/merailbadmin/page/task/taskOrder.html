<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>账单</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=318"/>
    <script src="../../assets/js/moment.js"></script>

    <style>

        .currSerachBtn{
            box-shadow: 0 15px 18px -6px rgb(45 140 240 / 65%) !important;
        }

        .currReloadBtn{
            box-shadow: 0 15px 18px -6px rgb(146 109 222 / 65%) !important;
        }

        .layui-table-cell{
            height:36px;
            line-height: 36px;
        }


    </style>

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">


            <!-- 表格工具栏 -->
            <form class="layui-form toolbar">
                <div class="layui-form-item" style="margin-left: -40px">
                    <div class="layui-inline">
                        <label class="layui-form-label">用户名:</label>
                        <div class="layui-input-inline">
                            <input name="username" class="layui-input" placeholder="请输入用户名"/>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态:</label>
                        <div class="layui-input-inline">
                            <select name="status" id="status">
                                <option value="999">所有类型</option>
                                <option value="1">已分配未领取</option>
                                <option value="2">已领取未完成</option>
                                <option value="3">已领取已完成</option>
                                <option value="4">提交任务中</option>
                                <option value="5">已提交,未结算</option>
                                <option value="6">已冻结</option>
                            </select>
                        </div>
                    </div>

<!--                    <div class="layui-inline">-->
<!--                        <label class="layui-form-label">日期</label>-->
<!--                        <div class="layui-input-inline">-->
<!--                            <input type="text" class="layui-input" id="buildDate" name="buildDate" placeholder="yyyy-MM-dd">-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    <div class="layui-inline">-->
<!--                        <label class="layui-form-label">用户名:</label>-->
<!--                        <div class="layui-input-inline">-->
<!--                            <input name="nickName" class="layui-input" placeholder="输入用户名"/>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="layui-inline">-->
<!--                        <label class="layui-form-label">操作等级:</label>-->
<!--                        <div class="layui-input-inline">-->
<!--                            <select name="level" id="level">-->
<!--                                <option value="normal">请选择操作登录</option>-->
<!--                                <option value="normal">正常</option>-->
<!--                                <option value="warn">警告</option>-->
<!--                            </select>-->
<!--                        </div>-->
<!--                    </div>-->
                    <div class="layui-inline">&emsp;
                        <button class="layui-btn icon-btn currSerachBtn" lay-filter="userTbSearch" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                        <button class="layui-btn icon-btn currReloadBtn" lay-filter="reloadData" lay-submit style="background-color: #926dde;border-color: #926dde;">
                            <i class="layui-icon layui-icon-refresh"></i>刷新数据
                        </button>
                    </div>
                </div>
            </form>
            <!-- 数据表格 -->
            <table id="userTable" lay-filter="userTable" style="margin-top:10px"></table>
        </div>
    </div>
</div>


<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=318"></script>

<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="../../assets/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../assets/js/config.url.js"></script>

<!--数据表格操作工具栏-->
<script type="text/html" id="orderListBar">
    <a class="layui-btn layui-btn-xs " lay-event="rechargebtn"><i class="layui-icon">&#xe605;</i>充值</a>
    <a class="layui-btn layui-btn-xs " lay-event="changebtn"><i class="layui-icon">&#xe605;</i>修改</a>
<!--    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delbtn"><i class="layui-icon">&#x1006;</i>删除</a>-->
</script>
<script>

    var mybck= $.cookie('tokenMyb');
    //alert(document.cookie);
    //console.log(mybck)
    if(mybck == "" || mybck == null){

        window.top.location.href="../../login.html";

    }else{

        var currDateVal
        layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect','laydate'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            var table = layui.table;
            var util = layui.util;
            var admin = layui.admin;
            var laydate = layui.laydate;
            var xmSelect = layui.xmSelect;

            //常规用法
            laydate.render({
                elem: '#buildDate'
                // ,value: currDate
                ,isInitValue: true
                ,theme: 'molv'
                ,done: function(value, date){//选中后的回调
                    // layer.alert('你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                    // console.log("自带的",date)
                    // console.log("jquery",$("#buildDate").val())
                    currDateVal = ""
                    currDateVal = value
                }
            });


            var log_login_request_param = {};
            // log_login_request_param['player_id']= '1';
            // log_login_request_param['token']= $.cookie('tokenMyb');


            /* 渲染表格 */
            var insTb = table.render({
                elem: '#userTable',
                url: global_requestAddress + global_requestAddress_js_taskOrder +"?action=select",
                headers:{
                    token:mybck
                },
                method: 'post',
                where:log_login_request_param,
                response: {
                    statusCode: 2000,
                    dataName: 'result',
                },
                // toolbar: ['<p>',
                //     '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                //     '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>',
                //     '</p>'].join(''),
                cellMinWidth: 100,
                page :  { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    ,groups: 10 //只显示 1 个连续页码
                    ,first: "首页" //不显示首页
                    ,last: "尾页"//不显示尾页
                },
                height : "full-100",
                limit : 15,
                limits : [15,30,50,100],
                // id : "systemLog",
                cols: [[
                    {type: 'checkbox'},
                    {field: 'ID',title:'ID',sort: true,align:"center"},
                    {field: 'Username', title: '用户名', sort: true,align:"center"},
                    {field: 'TopAgent', title: '顶级代理', sort: true,align:"center"},
                    {field: 'TaskName', title: '任务名', sort: true,align:"center"},
                    {field: 'OrderMoney', title: '订单金额', sort: true,align:"center"},
                    {field: 'CommissionMoney', title: '佣金金额', sort: true,align:"center"},
                    {field: 'PayPer', title: '支付比例', sort: true,align:"center"},
                    {field: 'CommissionRate', title: '佣金比例', sort: true,align:"center"},

                    {field: 'Status', title: '状态', sort: true,align:"center",width:130,templet:function(d){
                            if(d.Status == "1"){//已分配未领取
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #227aff;border-color: #227aff;">'+'已分配未领取'+'</button>'
                            }else if(d.Status == "2"){//已领取未完成
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #33cabb;border-color: #33cabb;">'+'已领取未完成'+'</button>'
                            }else if(d.Status == "3"){//已领取已完成
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #926dde ;border-color: #926dde ;">'+'已领取已完成 '+'</button>'
                            }else if(d.Status == "4"){//提交任务中
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #faa64b;border-color: #faa64b;">'+'提交任务中'+'</button>'
                            }else if(d.Status == "5"){//已提交,未结算
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #FF5722;border-color: #FF5722;">'+'已提交,未结算'+'</button>'
                            }else if(d.Status == "6"){//已冻结
                                return '<button class="layui-btn  layui-btn-sm" style="background-color: #465161;border-color: #465161;">'+'已冻结'+'</button>'
                            }else{
                                return ''
                            }
                    }},

                    {field: 'GoodsName', title: '商品名', sort: true,align:"center"},
                    {field: 'GoodsImageUrl', title: '商品图片', sort: true,align:"center", templet: function (d) {
                            var imageName = global_requestAddress+"/"+d.GoodsImageUrl;
                            return '<div><img src="'+imageName+'" ' + 'alt="" width="40px" height="40px"></a></div>';
                        }},
                    {field: 'ClearAt', width:180, title: '结算时间', sort: true,align:"center", templet: function (d) {
                            // return util.toDateString(d.ClearAt* 1000);
                            return moment(d.ClearAt * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');

                        }},
                    {field: 'GetAt',width:180, title: '超时付款时间', sort: true,align:"center", templet: function (d) {
                            // return util.toDateString(d.GetAt* 1000);
                            return moment(d.GetAt * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');

                        }},

                    {
                        field: 'Created', width:180, title: '创建时间',align:"center", templet: function (d) {
                            // return util.toDateString(d.Created* 1000);
                            return moment(d.Created * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');

                        }, sort: true
                    },
                    {
                        field: 'Updated',width:180, title: '更新时间',align:"center", templet: function (d) {
                            // return util.toDateString(d.Updated* 1000);
                            return moment(d.Updated * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');

                        }, sort: true
                    },
                    // {title: '操作', width:250, templet:'#orderListBar',fixed:"right",align:"center"}
                ]],
                done: function (res, curr, count) {
                    $('tr').css({'background-color': '#fff', 'color': '#191a1c'});
                }
            });

            /* 表格搜索 */
            var bet_tb_this;
            var currTempObj = {};
            form.on('submit(userTbSearch)', function (data) {
                // console.log("datafield",data.field);

                currTempObj = {}
                if(data.field.username == ""){


                }else{

                    currTempObj.username = data.field.username

                }

                if(data.field.status == "999"){


                }else{

                    currTempObj.status = data.field.status

                }





                //2.6.0之前清除保留之前的数据的最有用的方式
                if (bet_tb_this != null) {
                    // console.log("book_tb_this--不为null",bet_tb_this)
                    bet_tb_this.where = {};  //置空where
                }
                if(data.field.kinds == "999"){
                    // insTb.reload({
                    //     url:js_global_requestAddress_get_record_lists,
                    //     where: currTempObj,
                    //     done:function(){
                    //         bet_tb_this = this;
                    //         // console.log("book_tb_this----重载后的值",bet_tb_this)
                    //     }
                    // },false);

                }else {


                    insTb.reload({
                        where: currTempObj
                        , page: {curr: 1},
                        done:function(){
                            bet_tb_this = this;
                            // console.log("book_tb_this----重载后的值",bet_tb_this)
                        }
                    });
                }

                return false;
            });

            /* 表格工具条点击事件 */
            table.on('tool(userTable)', function (obj) {
                var currDatas  = obj.data;
                if (obj.event === 'changebtn') { // 修改
                    // showEditModel(obj.data);
                    layer.prompt({title: '系统将对该用户进行封禁操作,确定当前用户进行封禁状态吗?', formType:2}, function(text, index){
                        var param={};
                        param['token']= $.cookie('tokenMyb');
                        param['status']= '2';
                        param['remark']= text;
                        param['id']= currDatas.id;

                        // param = wxgl_tgsh_btgbtn_jinyongbtn_Request($.cookie('tokenMyb'),'2',text,currDatas.wx_number,currDatas.id);
                        $.post(js_global_requestAddress_change_players_status, param,
                            function(lookResult){
                                if(lookResult.code === 200 ){
                                    layer.msg(lookResult.msg);
                                    insTb.reload();
                                    layer.close(index);
                                }else{


                                }


                            });


                    });

                } else if (obj.event === 'del') { // 删除
                    doDel(obj);
                } else if (obj.event === 'rechargebtn') { // 充值
                    resetPsw(obj);
                }
            });

            /* 表格头工具栏点击事件 */
            table.on('toolbar(userTable)', function (obj) {
                if (obj.event === 'add') { // 添加
                    showEditModel();
                } else if (obj.event === 'del') { // 删除
                    var checkRows = table.checkStatus('userTable');
                    if (checkRows.data.length === 0) {
                        layer.msg('请选择要删除的数据', {icon: 2});
                        return;
                    }
                    var ids = checkRows.data.map(function (d) {
                        return d.userId;
                    });
                    doDel({ids: ids});
                }
            });

            /* 显示表单弹窗 */
            function showEditModel(mData) {
                admin.open({
                    type: 1,
                    title: (mData ? '修改' : '添加') + '用户',
                    content: $('#userEditDialog').html(),
                    success: function (layero, dIndex) {
                        // 回显表单数据
                        form.val('userEditForm', mData);
                        // 表单提交事件
                        form.on('submit(userEditSubmit)', function (data) {
                            data.field.roleIds = insRoleSel.getValue('valueStr');
                            var loadIndex = layer.load(2);
                            $.get(mData ? '../../json/ok.json' : '../../json/ok.json', data.field, function (res) {  // 实际项目这里url可以是mData?'user/update':'user/add'
                                layer.close(loadIndex);
                                if (res.code === 200) {
                                    layer.close(dIndex);
                                    layer.msg(res.msg, {icon: 1});
                                    insTb.reload({page: {curr: 1}});
                                } else {
                                    layer.msg(res.msg, {icon: 2});
                                }
                            }, 'json');
                            return false;
                        });
                        // 渲染多选下拉框
                        var insRoleSel = xmSelect.render({
                            el: '#userEditRoleSel',
                            name: 'userEditRoleSel',
                            layVerify: 'required',
                            layVerType: 'tips',
                            data: [{
                                name: '管理员',
                                value: 1
                            }, {
                                name: '普通用户',
                                value: 2
                            }, {
                                name: '游客',
                                value: 3
                            }]
                        });
                        // 回显选中角色
                        if (mData && mData.roles) {
                            insRoleSel.setValue(mData.roles.map(function (item) {
                                return item.roleId;
                            }));
                        }
                        // 禁止弹窗出现滚动条
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                    }
                });
            }

            /* 删除 */
            function doDel(obj) {
                layer.confirm('确定要删除选中数据吗？', {
                    skin: 'layui-layer-admin',
                    shade: .1
                }, function (i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.get('../../json/ok.json', {
                        id: obj.data ? obj.data.userId : '',
                        ids: obj.ids ? obj.ids.join(',') : ''
                    }, function (res) {
                        layer.close(loadIndex);
                        if (res.code === 200) {
                            layer.msg(res.msg, {icon: 1});
                            insTb.reload({page: {curr: 1}});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                });
            }

            /* 修改用户状态 */
            form.on('switch(userTbStateCk)', function (obj) {
                var loadIndex = layer.load(2);
                $.get('../../json/ok.json', {
                    userId: obj.elem.value,
                    state: obj.elem.checked ? 0 : 1
                }, function (res) {
                    layer.close(loadIndex);
                    if (res.code === 200) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        $(obj.elem).prop('checked', !obj.elem.checked);
                        form.render('checkbox');
                    }
                }, 'json');
            });

            /* 重置密码 */
            function resetPsw(obj) {
                layer.confirm('确定要重置“' + obj.data.nickName + '”的登录密码吗？', {
                    skin: 'layui-layer-admin',
                    shade: .1
                }, function (i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.get('../../json/ok.json', {
                        userId: obj.data.userId
                    }, function (res) {
                        layer.close(loadIndex);
                        if (res.code === 200) {
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                });
            }

        });

    }



</script>
</body>
</html>
