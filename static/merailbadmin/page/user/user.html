<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户列表</title>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../assets/module/admin.css?v=318"/>
    <script type="text/javascript" src="../../assets/js/clipboard.min.js"></script>
    <script src="../../assets/js/moment.js"></script>

    <style>

        .currSerachBtn {
            box-shadow: 0 15px 18px -6px rgb(45 140 240 / 65%) !important;
        }

        .currReloadBtn {
            box-shadow: 0 15px 18px -6px rgb(146 109 222 / 65%) !important;
        }

        .layui-table-cell {
            height: 40px;
            line-height: 40px;
        }

    </style>


    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <div style="display: flex">

                <div class="dropdown-menu" style="margin-right: 20px">
                    <button class="layui-btn layui-btn-normal icon-btn">
                        &nbsp;邀请内容 <i class="layui-icon layui-icon-drop"></i></button>
                    <div class="dropdown-menu-nav "
                         style="width: 280px;padding: 0 10px 10px 10px;">
                        <div class="dropdown-anchor"></div>
                        <div class="layui-tab layui-tab-brief" lay-filter="tabCopy">
                            <ul class="layui-tab-title">
                                <li class="layui-this">邀请地址</li>
                                <li>邀请码</li>
                            </ul>
                            <div class="layui-tab-content" style="padding: 10px 0 10px 0;">
                                <div class="layui-tab-item layui-show layui-text">
                                    <input class="layui-input" value="www.baidu.com" readonly id="inviteLink"/>
                                </div>
                                <div class="layui-tab-item layui-text">
                                    <input class="layui-input" value="www.google.com" readonly id="inviteCode"/>
                                </div>
                            </div>
                        </div>
                        <button class="layui-btn layui-btn-sm layui-btn-fluid" style="margin-bottom: 10px;"
                                id="copyBtn">
                            复制
                        </button>
                        <img src="../../assets/images/copyimg2.jpg" width="100%"/>
                    </div>

                </div>

                <div>
                    <!-- 表格工具栏 -->
                    <form class="layui-form toolbar">
                        <div class="layui-form-item" style="margin-left: -45px">
                            <div class="layui-inline">
                                <label class="layui-form-label">用户名:</label>
                                <div class="layui-input-inline">
                                    <input name="username" id="username" class="layui-input" placeholder="请输入用户名"/>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">顶级代理:</label>
                                <div class="layui-input-inline">
                                    <input name="top_agent" id="top_agent" class="layui-input" placeholder="请输入顶级代理"/>
                                </div>
                            </div>

                            <div class="layui-inline">&emsp;
                                <button class="layui-btn icon-btn currSerachBtn" lay-filter="userTbSearch" lay-submit>
                                    <i class="layui-icon">&#xe615;</i>搜索
                                </button>
                                <button class="layui-btn icon-btn currReloadBtn" lay-filter="reloadData" lay-submit
                                        style="background-color: #926dde;border-color: #926dde;">
                                    <i class="layui-icon layui-icon-refresh"></i>刷新数据
                                </button>
                                <button class="layui-btn icon-btn currReloadBtn" id="addaccount"
                                        style="background-color: #f96197;border-color: #f96197;">
                                    <i class="layui-icon layui-icon-addition"></i>添加
                                </button>
                            </div>


                        </div>
                    </form>
                </div>


            </div>
            <!-- 数据表格 -->
            <table id="authoritiesTable"></table>

            <!-- 数据表格 -->
            <table id="userTable" lay-filter="userTable" style="margin-top:10px"></table>
        </div>
    </div>
</div>


<!-- js部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/js/common.js?v=318"></script>

<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="../../assets/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../../assets/js/config.url.js"></script>


<script type="text/html" id="orderListBar">

    <!--        <a class="layui-btn layui-btn-sm layui-btn-radius" lay-event="rechargebtn" ><i class="layui-icon layui-icon-rmb"></i>充值</a>-->
    <!--        <a class="layui-btn layui-btn-sm layui-btn-radius " lay-event="infobtn" style="background-color: #fff;color: #0C0C0C;border: 1px solid #C9C9C9;"><i class="layui-icon">&#xe615;</i>详情</a>-->
    <!--        <a class="layui-btn layui-btn-sm layui-btn-radius " lay-event="yuebdbtn" style="background-color: #fb7299;color: #ffffff;"><i class="layui-icon layui-icon-form"></i>余额变动</a>-->
    <!--        <a class="layui-btn layui-btn-sm layui-btn-radius " lay-event="changebtn" style="background-color: #009688"><i class="layui-icon layui-icon-edit"></i>修改余额</a>-->
    <!--        <a class="layui-btn layui-btn-sm layui-btn-radius " lay-event="tixianbtn" style="background-color: #fbc472"><i class="layui-icon layui-icon-down"></i>提现下分</a>-->
    <a class="layui-btn layui-btn-sm " style="background: #ffba00" data-dropdown="#userTbDrop{{d.LAY_INDEX}}"
       no-shade="true">
        任务操作<i class="layui-icon layui-icon-drop" style="font-size: 12px;margin-right: 0;"></i></a>
    <!-- 下拉菜单 -->
    <ul class="dropdown-menu-nav dropdown-bottom-center layui-hide  " id="userTbDrop{{d.LAY_INDEX}}">
        <div class="dropdown-anchor"></div>
        <li><a lay-event="dispatchTask">分配任务</a></li>
        <li><a lay-event="hisTask">历史任务</a></li>
    </ul>


    <a class="layui-btn layui-btn-sm " style="background: #11a983" data-dropdown="#userTbDropPerson{{d.LAY_INDEX}}"
       no-shade="true">
        个人操作<i class="layui-icon layui-icon-drop" style="font-size: 12px;margin-right: 0;"></i></a>
    <!-- 下拉菜单 -->
    <ul class="dropdown-menu-nav dropdown-bottom-center layui-hide  " id="userTbDropPerson{{d.LAY_INDEX}}">
        <div class="dropdown-anchor"></div>
        <li><a lay-event="lookOperate">查看</a></li>
        <li><a lay-event="editOperate">修改</a></li>
        <li><a lay-event="changeBankOperate">修改银行卡</a></li>
        <li><a lay-event="changeMoneyOperate">余额变动</a></li>
        <li><a lay-event="accountMoenyRecord">账变记录</a></li>
    </ul>
</script>

<script>

    var mybck = $.cookie('tokenMyb');
    //alert(document.cookie);
    // console.log("mybck",mybck)
    if (mybck == "" || mybck == null) {

        window.top.location.href = "../../login.html";

    } else {
        var copyContent = $("#inviteLink").val()
        var viplist = []

        $.ajax({
            url: global_requestAddress + global_requestAddress_js_vip + "?action=select",
            headers: {
                token: mybck
            },
            method: "post",
            data: "",
            dataType: "json",
            success: function (res) {

                if (res.code === 2000) { //成功的拿到了数据
                    viplist = res.result
                    // console.log("viplist",viplist)
                }

            }
        })

        $.ajax({
            url: global_requestAddress + global_requestAddress_js_user + "?action=select",
            headers: {
                token: mybck
            },
            method: "post",
            data: {
                operation: "invite_code",
            },
            dataType: "json",
            success: function (res) {

                if (res.code === 2000) { //成功的拿到了数据
                    if (res.result) {
                        let resR = res.result[0]
                        $("#inviteLink").val(resR.url)
                        $("#inviteCode").val(resR.invite_code)
                    }
                    // if(data.index === 0){ //邀请链接内容
                    //     copyContent = $("#inviteLink").val()
                    // }else if(data.index === 1){ //邀请码内容
                    //     copyContent = $("#inviteCode").val()
                    // }
                }

            }
        })

        var jsondata;
        var local_storage_key = 'user_t_list';
        layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect', 'notice', 'treeTable', 'dropdown', 'element'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            var table = layui.table;
            var util = layui.util;
            var admin = layui.admin;
            var xmSelect = layui.xmSelect;
            var notice = layui.notice;
            var treeTable = layui.treeTable
            var dropdown = layui.dropdown;
            var element = layui.element;  //tab需要引入到

            // var log_login_request_param = {};
            // log_login_request_param['status']= '1';
            // log_login_request_param['token']= $.cookie('tokenMyb');

            var tableCols = tableSetCol(getTableCols(), local_storage_key);
            // console.log("tableCols",tableCols)
            /* 渲染表格 */
            var insTb = table.render({
                elem: '#userTable',
                url: global_requestAddress + global_requestAddress_js_user + "?action=select",
                method: 'post',
                headers: {
                    token: mybck,
                },
                response: {
                    statusCode: 2000,
                    dataName: 'result',
                },
                // where:log_login_request_param,
                toolbar: true,
                defaultToolbar: ['filter'],
                // toolbar: ['<p>',
                //     '<button lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                //     '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>',
                //     '</p>'].join(''),
                cellMinWidth: 100,
                page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    , groups: 10 //只显示 1 个连续页码
                    , first: "首页" //不显示首页
                    , last: "尾页"//不显示尾页
                },
                height: "full-100",
                limit: 15,
                limits: [15, 30, 50, 100],
                // id : "systemLog",
                cols: tableCols,
                done: function (res, curr, count) {
                    $('tr').css({'background-color': '#fff', 'color': '#191a1c'});
                    tableDone(this.elem, insTb.config.cols[0], local_storage_key)
                }
            });

            //layui表格渲染后，事件需要重新绑定，并记录下筛选信息于localStorage
            function tableDone(elem, col, key){
                elem.next().find('[lay-event="LAYTABLE_COLS"]').click(function(e) {
                    setTimeout(function() {
                        layui.$(e.currentTarget).find('.layui-form-checkbox').click(function() {
                            var local_config = {};
                            for(var i = 0; i<=col.length-1; i++){
                                if(typeof col[i].field !== 'undefined'){
                                    local_config[col[i].field] = col[i].hide ;
                                }
                            }
                            var saveColsConfig = {
                                key: 'local_config',
                                value: local_config
                            };

                            console.log("saveColsConfig",saveColsConfig)
                            layui.data(key, saveColsConfig);
                        })
                    }, 50);
                })
            }


            //表格 头部数据函数封装
            function getTableCols() {
                var col = [[
                    {type: 'checkbox'},
                    {field: 'ID', title: 'id', sort: true, align: "center", width: 70},
                    {field: 'Username', title: '用户名', width: 120, sort: true, align: "center"},
                    {field: 'InvitationCode', title: '邀请码', width: 100, sort: true, align: "center"},
                    {field: 'Phone', title: '手机号', width: 120, sort: true, align: "center"},
                    {field: 'TopAgent', title: '顶级代理', width: 120, sort: true, align: "center"},
                    {field: 'TopAgent', title: '上级代理', width: 120, sort: true, align: "center"},
                    {field: 'Balance', title: '余额', width: 120, sort: true, align: "center"},
                    {field: 'WithdrawFreeze', title: '提现冻结', width: 120, sort: true, align: "center"},
                    {field: 'WorkingFreeze', title: '业务冻结', width: 120, sort: true, align: "center"},

                    {
                        field: 'DoingTask',
                        title: '分组任务',
                        width: 120,
                        sort: true,
                        align: "center",
                        templet: function (d) {
                            var taskname = d.DoingTask.TaskName
                            return taskname
                        }
                    },

                    {
                        field: 'VipId', title: 'VIP等级', width: 120, sort: true, align: "center", templet: function (d) {

                            var vipID = d.VipId
                            var vipName = ""
                            viplist.forEach((item, index) => {
                                if (item.ID === vipID) {
                                    vipName = item.Name
                                }
                            })

                            return vipName

                        }
                    },

                    {
                        field: 'Kinds', title: '账号类型', width: 120, sort: true, align: "center", templet: function (d) {
                            if (d.Kinds === 1) { //正式号
                                return "正式号"
                            } else { //测试号
                                return "测试号"
                            }

                        }
                    },

                    {field: 'CreatedCountry', title: '地区', width: 120, sort: true, align: "center"},
                    {field: 'TheScLoginIp', title: '上次登录IP', width: 130, sort: true, align: "center"},
                    {
                        field: 'TheScLoginTime', title: '上次登录时间', width: 170, sort: true, align: "center",
                        templet: function (d) {
                            if (d.TheScLoginTime) {
                                return moment(d.TheScLoginTime * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');
                            } else {
                                return ""
                            }

                            // return util.toDateString(d.TheScLoginTime * 1000);
                        }
                    },
                    {field: 'TheLastLoginIp', title: '最后次登录IP', width: 130, sort: true, align: "center"},
                    {
                        field: 'TheLastLoginTime',
                        title: '最后次登录时间',
                        width: 180,
                        sort: true,
                        align: "center",
                        templet: function (d) {

                            // console.log("TheLastLoginTime",d.TheLastLoginTime)
                            return moment(d.TheLastLoginTime * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');
                            // return util.toDateString(d.TheLastLoginTime * 1000);
                        }
                    },
                    {
                        field: 'Status', title: '状态', sort: true, align: "center", width: 120, templet: function (d) {
                            var state = "";
                            if (d.Status == "1") {//正常,checked 打开
                                state = "<input type='checkbox' value='" + d.Status + "' id='user_status' lay-filter='user_status'  name='user_status'  lay-skin='switch' lay-text='正常|禁用' checked>";
                                return state;
                            } else if (d.Status == "2") {//禁用
                                state = "<input type='checkbox' value='" + d.Status + "' id='user_status' lay-filter='user_status'  name='user_status'  lay-skin='switch' lay-text='正常|禁用'>";
                                return state;
                            } else {
                                return ''
                            }

                        }
                    },

                    {
                        field: 'Created',
                        title: '创建时间',
                        width: 170,
                        sort: true,
                        align: "center",
                        templet: function (d) {
                            return moment(d.Created * 1000).utc().utcOffset(currTimeZoneValue).format('YYYY-MM-DD HH:mm:ss');
                            // return moment(d.Created * 1000).utc().zone(+6).format('YYYY-MM-DD HH:mm:ss');
                            // console.log("getLocalTime()",getLocalTime(-6,d.Created))
                            // return util.toDateString(d.Created * 1000);
                        }
                    },

                    {title: '操作', width: 230, templet: '#orderListBar', fixed: "right", align: "center"}

                ]]
                return col;
            }

            //layuitable reload或第一次加载的时候，根据存储的local_config 确定哪些列是否选中
            function tableSetCol(col, key){
                let colArr = col[0]
                var config_custom= layui.data(key);
                var local_config = config_custom['local_config'] || {};
                if(JSON.stringify(local_config) != '{}'){
                    for(var i =0; i<=colArr.length-1; i++){
                        if( typeof colArr[i].field !== "undefined" ){
                            colArr[i].hide = local_config[colArr[i].field];
                        }
                    }
                }
                return [colArr];
            }


            /* 表格搜索 */
            var currTempObj;
            var bet_tb_this;
            form.on('submit(userTbSearch)', function (data) {

                // console.log("currTempObj",data.field.username)
                // insTb.reload({where: data.field, page: {curr: 1}});
                currTempObj = {}

                if (data.field.username === "") {

                } else {
                    currTempObj.username = data.field.username
                }

                if (data.field.top_agent === "") {

                } else {
                    currTempObj.top_agent = data.field.top_agent
                }


                //2.6.0之前清除保留之前的数据的最有用的方式
                if (bet_tb_this != null) {
                    // console.log("book_tb_this--不为null",bet_tb_this)
                    bet_tb_this.where = {};  //置空where
                }
                insTb.reload({
                    where: currTempObj,
                    page: {curr: 1},
                    done: function () {
                        bet_tb_this = this;
                        // console.log("book_tb_this----重载后的值",bet_tb_this)
                    }
                }, false);


                return false;
            });

            //复制内容监听函数
            var clipboard2 = new ClipboardJS('#copyBtn', {
                text: function () {
                    return copyContent;
                }
            });
            clipboard2.on('success', function (e) {
                layer.msg("复制成功！");
            });
            clipboard2.on('error', function (e) {
                layer.msg("复制失败！请手动复制")
            });

            //tab切换监听事件
            element.on('tab(tabCopy)', function (data) {
                // console.log(data);
                if (data.index === 0) { //邀请链接内容
                    copyContent = $("#inviteLink").val()
                } else if (data.index === 1) { //邀请码内容
                    copyContent = $("#inviteCode").val()
                }


            });


            //添加账号
            $("#addaccount").click(function () {
                var index = layui.layer.open({
                    area: ['600px', '500px'],
                    fixed: false, //不固定
                    maxmin: false,
                    title: "添加账号",
                    skin: 'layui-layer-rim',//加上边框
                    type: 2,
                    content: "user_add.html",
                    success: function (layero, index) {
                        var body = layui.layer.getChildFrame('body', index);


                    },
                    end: function () {//弹窗关闭后的回调函数
                        //利用laypage实现局部刷新,以下两种方式都可以
                        // $(".layui-laypage-btn").click()
                        //直接刷新当前修改的行
                        $(".layui-laypage-btn")[0].click()

                    }
                })
                window.sessionStorage.setItem("index", index);
                //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                $(window).on("resize", function () {
                    layui.layer.full(window.sessionStorage.getItem("index"));
                })

                return false
            })


            //监听禁用开关按钮操作
            form.on('switch(user_status)', function (obj) {

                // console.log("obj",obj)

                // 获取当前控件
                var selectIfKey = obj.othis;
                // 获取当前所在行
                var parentTr = selectIfKey.parents("tr");
                // 获取当前所在行的索引
                // var parentTrIndex = parentTr.attr("data-index");

                //通过相对位置找对应行数据
                // 获取当前行第一和三列的值
                var currentwx_id = parentTr.find(('td:eq(1)')).text().trim();
                // console.log("currentwx_id", currentwx_id)


                var currStatusBool = obj.elem.checked;
                // console.log("currStatusBool",currStatusBool)
                var messageTitle = '';
                var currStatusNum = 0;
                if (currStatusBool) {  //currStatusBool true
                    messageTitle = '系统将对该用户进行开启操作,确定对当前用户进行开启操作吗?'
                } else { //false

                    messageTitle = '系统将对该用户进行禁用操作,确定对当前用户进行禁用操作吗?'

                }

                //弹窗组件
                layer.open({
                    // type: 2,
                    area: ['450px', '195px'],
                    fix: false,
                    //不固定
                    maxmin: true,
                    shade: 0.3,
                    skin: 'layui-layer-rim',//加上边框
                    title: "温馨提示",
                    content: messageTitle,
                    // content: `<div>`+messageTitle+`</div>`,
                    btn: ['确定', '取消'],
                    // // 弹层外区域关闭
                    shadeClose: true,
                    btn1: function (index, layero) {//确定事件
                        //点击第一个按钮处理逻辑
                        // layer.msg("1");
                        if (currStatusBool) {
                            currStatusNum = 1
                        } else {
                            currStatusNum = 2
                        }

                        //进行ajax请求
                        var param = {};
                        param.status = currStatusNum
                        //这个就是当前那条数据的ID
                        param.user_id = currentwx_id

                        $.ajax({
                            url: global_requestAddress + global_requestAddress_js_user + "?action=update",
                            method: 'POST',
                            data: param,
                            dataType: "json",
                            headers: {
                                token: mybck,
                            },
                            success: function (res) {
                                if (res.code === 2000) {  //
                                    notice.msg(res.msg, {icon: 1});
                                    //列表的刷新
                                    insTb.reload();
                                    //关闭第一个弹窗的组件ID
                                    layer.close(index);
                                } else {
                                    notice.msg(res.msg, {icon: 2});
                                    insTb.reload();
                                    layer.close(index);
                                }
                            }
                        })


                        //
                        // $.post(js_global_requestAddress_change_password, param,
                        //     function(lookResult){
                        //
                        //         if(lookResult.code === 200 ){
                        //
                        //
                        //             notice.msg(lookResult.msg, {icon: 1});
                        //             // setTimeout(function () {
                        //             //     var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        //             //     parent.layer.close(index);
                        //             //     window.parent.location.reload();
                        //             // }, 1300)
                        //
                        //
                        //             insTb.reload();
                        //             layer.close(index);
                        //
                        //
                        //         }else{
                        //
                        //
                        //             notice.msg(lookResult.msg, {icon: 2});
                        //             insTb.reload();
                        //             layer.close(index);
                        //
                        //         }
                        //
                        //
                        //     });


                    },
                    btn2: function (index, layero) {//取消事件
                        //点击第二个按钮处理逻辑
                        // layer.msg("2");

                        notice.msg("取消操作", {icon: 5});
                        // $.message({
                        //     message: "取消操作",
                        //     type: 'info',
                        //     showClose: true
                        // });

                        var x = obj.elem.checked;

                        obj.elem.checked = !x;
                        form.render();
                        layer.close(index);
                    },
                    cancel: function (index, layero) {//取消事件
                        //点击第二个按钮处理逻辑
                        // layer.msg("2");
                        notice.msg("取消操作", {icon: 5});
                        var x = obj.elem.checked;
                        obj.elem.checked = !x;
                        form.render();
                        layer.close(index);
                    }
                })


            });


            //监听单元格编辑
            table.on('edit(userTable)', function (obj) {
                var value = obj.value //得到修改后的值
                    , data = obj.data //得到所在行所有键值
                    , field = obj.field; //得到字段

                // layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改值为：'+ util.escape(value));

                var param = {};
                param['token'] = $.cookie('tokenMyb');
                param['definition'] = util.escape(value);
                param['id'] = data.id;

                $.ajax({
                    url: js_global_requestAddress_change_password,
                    data: param,
                    type: "POST",
                    dataType: "json",
                    success: function (addResult) {

                        if (addResult.code === 200) {

                            notice.msg(addResult.msg, {icon: 1});


                        } else {

                            // layer.msg(addResult.msg);
                            notice.msg(addResult.msg, {icon: 2});


                        }


                    },


                });


            });


            /* 表格工具条点击事件 */
            table.on('tool(userTable)', function (obj) {
                var currDatas = obj.data;
                if (obj.event === 'editOperate') { // 修改
                    // showEditModel(obj.data);

                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['600px', '500px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "修改个人信息",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_edit.html",
                        success: function (layero, index) {
                            var body = layui.layer.getChildFrame('body', index);

                            if (currDatas) {

                            }

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            $(".layui-laypage-btn")[0].click()

                        }
                    })
                    window.sessionStorage.setItem("index", index);
                    //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    $(window).on("resize", function () {
                        layui.layer.full(window.sessionStorage.getItem("index"));
                    })

                } else if (obj.event === 'lookOperate') { // 详情
                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['500px', '500px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "查看详情",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_info.html",
                        success: function (layero, index) {
                            var body = layui.layer.getChildFrame('body', index);
                            if (currDatas) {

                            }

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            $(".layui-laypage-btn")[0].click()

                        }
                    })
                    // window.sessionStorage.setItem("index", index);
                    // //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    // $(window).on("resize", function () {
                    //     layui.layer.full(window.sessionStorage.getItem("index"));
                    // })

                } else if (obj.event === 'accountMoenyRecord') { // 账变记录

                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['1200px', '500px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "当前会员账变记录列表",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_money_record.html",
                        success: function (layero, index) {
                            // var body = layui.layer.getChildFrame('body', index);

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            // $(".layui-laypage-btn")[0].click()

                        }
                    })
                    window.sessionStorage.setItem("index", index);
                    //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    $(window).on("resize", function () {
                        layui.layer.full(window.sessionStorage.getItem("index"));
                    })


                } else if (obj.event === 'changeMoneyOperate') { // 余额变动

                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['600px', '400px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "余额变动",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_change_money.html",
                        success: function (layero, index) {
                            var body = layui.layer.getChildFrame('body', index);

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            $(".layui-laypage-btn")[0].click()
                        }
                    })
                    window.sessionStorage.setItem("index", index);
                    //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    $(window).on("resize", function () {
                        layui.layer.full(window.sessionStorage.getItem("index"));
                    })

                } else if (obj.event === 'changeBankOperate') { // 修改银行卡

                    var param = {};
                    param.operation = "detailOne"
                    param.user_id = currDatas.ID
                    $.ajax({
                        url: global_requestAddress + global_requestAddress_js_user + "?action=select",
                        headers: {
                            "token": mybck,
                        },
                        data: param,
                        type: "POST",
                        dataType: "json",
                        success: function (res) {
                            if (res.code === 2000) {
                                let bankArr = res.result.bank
                                if (bankArr.length !== 0) {
                                    jsondata = JSON.stringify(res.result)
                                    var index = layui.layer.open({
                                        area: ['600px', '500px'],
                                        fixed: false, //不固定
                                        maxmin: false,
                                        title: "修改银行卡",
                                        skin: 'layui-layer-rim',//加上边框
                                        type: 2,
                                        content: "user_change_bank.html",
                                        success: function (layero, index) {
                                            var body = layui.layer.getChildFrame('body', index);

                                        },
                                        end: function () {//弹窗关闭后的回调函数
                                            //利用laypage实现局部刷新,以下两种方式都可以
                                            // $(".layui-laypage-btn").click()
                                            //直接刷新当前修改的行
                                            $(".layui-laypage-btn")[0].click()

                                        }
                                    })
                                    // window.sessionStorage.setItem("index", index);
                                    // //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                                    // $(window).on("resize", function () {
                                    //     layui.layer.full(window.sessionStorage.getItem("index"));
                                    // })
                                } else {
                                    notice.msg("会员未绑定银行卡", {icon: 2});
                                }

                            }

                        },
                    });


                } else if (obj.event === 'dispatchTask') { // 分配任务
                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['1200px', '500px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "分配任务",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_dispatch_task.html",
                        success: function (layero, index) {
                            var body = layui.layer.getChildFrame('body', index);
                            if (currDatas) {

                            }

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            $(".layui-laypage-btn")[0].click()

                        }
                    })
                    // window.sessionStorage.setItem("index", index);
                    // //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    // $(window).on("resize", function () {
                    //     layui.layer.full(window.sessionStorage.getItem("index"));
                    // })

                } else if (obj.event === 'hisTask') { // 历史任务
                    jsondata = JSON.stringify(currDatas)
                    var index = layui.layer.open({
                        area: ['500px', '500px'],
                        fixed: false, //不固定
                        maxmin: false,
                        title: "历史任务",
                        skin: 'layui-layer-rim',//加上边框
                        type: 2,
                        content: "user_his_task.html",
                        success: function (layero, index) {
                            var body = layui.layer.getChildFrame('body', index);
                            if (currDatas) {

                            }

                        },
                        end: function () {//弹窗关闭后的回调函数
                            //利用laypage实现局部刷新,以下两种方式都可以
                            // $(".layui-laypage-btn").click()
                            //直接刷新当前修改的行
                            $(".layui-laypage-btn")[0].click()

                        }
                    })

                }


            });

            /* 表格头工具栏点击事件 */
            table.on('toolbar(userTable)', function (obj) {
                if (obj.event === 'add') { // 添加
                    showEditModel();
                } else if (obj.event === 'del') { // 删除
                    var checkRows = table.checkStatus('userTable');
                    if (checkRows.data.length === 0) {
                        layer.msg('请选择要删除的数据', {icon: 2});
                        return;
                    }
                    var ids = checkRows.data.map(function (d) {
                        return d.userId;
                    });
                    doDel({ids: ids});
                }
            });

            /* 显示表单弹窗 */
            function showEditModel(mData) {
                admin.open({
                    type: 1,
                    title: (mData ? '修改' : '添加') + '用户',
                    content: $('#userEditDialog').html(),
                    success: function (layero, dIndex) {
                        // 回显表单数据
                        form.val('userEditForm', mData);
                        // 表单提交事件
                        form.on('submit(userEditSubmit)', function (data) {
                            data.field.roleIds = insRoleSel.getValue('valueStr');
                            var loadIndex = layer.load(2);
                            $.get(mData ? '../../json/ok.json' : '../../json/ok.json', data.field, function (res) {  // 实际项目这里url可以是mData?'user/update':'user/add'
                                layer.close(loadIndex);
                                if (res.code === 200) {
                                    layer.close(dIndex);
                                    layer.msg(res.msg, {icon: 1});
                                    insTb.reload({page: {curr: 1}});
                                } else {
                                    layer.msg(res.msg, {icon: 2});
                                }
                            }, 'json');
                            return false;
                        });
                        // 渲染多选下拉框
                        var insRoleSel = xmSelect.render({
                            el: '#userEditRoleSel',
                            name: 'userEditRoleSel',
                            layVerify: 'required',
                            layVerType: 'tips',
                            data: [{
                                name: '管理员',
                                value: 1
                            }, {
                                name: '普通用户',
                                value: 2
                            }, {
                                name: '游客',
                                value: 3
                            }]
                        });
                        // 回显选中角色
                        if (mData && mData.roles) {
                            insRoleSel.setValue(mData.roles.map(function (item) {
                                return item.roleId;
                            }));
                        }
                        // 禁止弹窗出现滚动条
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                    }
                });
            }

            /* 删除 */
            function doDel(obj) {
                layer.confirm('确定要删除选中数据吗？', {
                    skin: 'layui-layer-admin',
                    shade: .1
                }, function (i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.get('../../json/ok.json', {
                        id: obj.data ? obj.data.userId : '',
                        ids: obj.ids ? obj.ids.join(',') : ''
                    }, function (res) {
                        layer.close(loadIndex);
                        if (res.code === 200) {
                            layer.msg(res.msg, {icon: 1});
                            insTb.reload({page: {curr: 1}});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                });
            }

            /* 修改用户状态 */
            form.on('switch(userTbStateCk)', function (obj) {
                var loadIndex = layer.load(2);
                $.get('../../json/ok.json', {
                    userId: obj.elem.value,
                    state: obj.elem.checked ? 0 : 1
                }, function (res) {
                    layer.close(loadIndex);
                    if (res.code === 200) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        $(obj.elem).prop('checked', !obj.elem.checked);
                        form.render('checkbox');
                    }
                }, 'json');
            });

            /* 重置密码 */
            function resetPsw(obj) {
                layer.confirm('确定要重置“' + obj.data.nickName + '”的登录密码吗？', {
                    skin: 'layui-layer-admin',
                    shade: .1
                }, function (i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.get('../../json/ok.json', {
                        userId: obj.data.userId
                    }, function (res) {
                        layer.close(loadIndex);
                        if (res.code === 200) {
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                });
            }

        });

    }


</script>
</body>
</html>
