<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link rel="stylesheet" href="../../assets/libs/layui/css/layui.css"/>
	<link rel="stylesheet" href="../../assets/module/admin.css?v=318"/>

	<!-- js部分 -->
	<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
	<script type="text/javascript" src="../../assets/js/common.js?v=318"></script>

	<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
	<script type="text/javascript" src="../../assets/js/jquery.cookie.min.js"></script>
	<script type="text/javascript" src="../../assets/js/config.url.js"></script>

</head>
<body class="childrenBody">
<!--<form class="layui-form" style="width:80%;margin-top: 20px">-->
<!--	<div class="layui-form-item layui-row layui-col-xs12">-->
<!--		<label class="layui-form-label" >余额</label>-->
<!--		<div class="layui-input-block">-->
<!--			<input type="text" class="layui-input " id="money" placeholder="请在此修改金额">-->
<!--		</div>-->
<!--	</div>-->
<!--	<div class="layui-form-item layui-row layui-col-xs12">-->
<!--		<div class="layui-input-block">-->
<!--			<button class="layui-btn layui-btn-lg"  lay-filter="addUser" id="comfireAdd">确认修改</button>-->
<!--			<button class="layui-btn layui-btn-lg layui-btn-primary"  lay-filter="cancelAdd" id="cancelAdd">取消</button>-->
<!--		</div>-->
<!--	</div>-->
<!--</form>-->
<form class="layui-form" style="padding: 20px;background-color: #fff">
	<div class="layui-form-item">
		<label class="layui-form-label">角色名称</label>
		<div class="layui-input-block">
			<input class="layui-input" type="text" name="role_name" id="role_name" placeholder="请输入角色名称"/>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">选择权限</label>
		<div class="layui-input-block">
			<div id="LAY-auth-tree-index"></div>
		</div>
	</div>
	<div class="layui-form-item" style="margin-top: 30px;">
		<div class="layui-input-block">
			<button class="layui-btn" type="submit" lay-submit lay-filter="LAY-auth-tree-submit">提交</button>
			<button class="layui-btn layui-btn-primary" type="reset">重置</button>
			<button class="layui-btn layui-btn-warm" lay-filter="cancelAdd" id="cancelAdd">取消</button>
		</div>
	</div>
</form>


<script>

	var mybck= $.cookie('tokenMyb');
	if(mybck == "" || mybck == null){


		window.top.location.href="../../login.html";

	}else {
		var currParentDatas = eval('('+parent.jsondata+')')
		let menuEditListArr =[{"Name":"首页","icon":"layui-icon layui-icon-home"},{"Name":"会员管理","icon":"iconfont icon-huiyuanguanli","Second":[{"Name":"普通会员","icon":"iconfont icon-huiyuanguanli","Status":1,"RouterPath":"user/user","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"Vip列表","icon":"iconfont icon-huiyuanguanli3","Status":1,"RouterPath":"user/vip","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"顶级会员","icon":"iconfont icon-kehuhuiyuanguanli","Status":1,"RouterPath":"user/topUser","Read":0,"Add":0,"Update":0,"Delete":0}]},{"Name":"任务管理","icon":"iconfont icon-renwu9","Second":[{"Name":"任务分组","icon":"iconfont icon-renwu10","Status":1,"RouterPath":"task/group","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"任务图片","icon":"iconfont icon-tupian9","Status":1,"RouterPath":"task/goods","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"任务订单","icon":"iconfont icon-quanbudingdan","Status":1,"RouterPath":"task/taskOrder","Read":0,"Add":0,"Update":0,"Delete":0}]},{"Name":"财务管理","icon":"iconfont icon-caiwuguanli5","Second":[{"Name":"支付管理","icon":"iconfont icon-chongzhi3","Status":1,"RouterPath":"money/pay","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"代付管理","icon":"iconfont icon-tixian18","Status":1,"RouterPath":"money/anotherPay","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"线上充值","icon":"iconfont icon-chongzhi17","Status":1,"RouterPath":"money/onLineRecharge","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"线下充值","icon":"iconfont icon-chongzhi","Status":1,"RouterPath":"money/OfflineRecharge","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"提现管理","icon":"iconfont icon-tixian19","Status":1,"RouterPath":"money/withdraw","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"银行管理","icon":"iconfont icon-yinhangka","Status":1,"RouterPath":"money/bank","Read":0,"Add":0,"Update":0,"Delete":0}]},{"Name":"日志管理","icon":"iconfont icon-rizhi","Second":[{"Name":"登录日志","icon":"iconfont icon-rizhiriqi","Status":1,"RouterPath":"log/login","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"注册日志","icon":"iconfont icon-rizhi1","Status":1,"RouterPath":"log/register","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"管理操作","icon":"iconfont icon-rizhiguanli1","Status":1,"RouterPath":"log/adminOperation","Read":0,"Add":0,"Update":0,"Delete":0}]},{"Name":"数据分析","icon":"iconfont icon-icon_website_huabanfuben","Second":[{"Name":"数据首页","icon":"iconfont icon-shujumofang","Status":1,"RouterPath":"data/firstPage","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"每日数据","icon":"iconfont icon-dashuju","Status":1,"RouterPath":"data/everyday","Read":0,"Add":0,"Update":0,"Delete":0}]},{"Name":"系统管理","icon":"iconfont icon-xitong5","Second":[{"Name":"用户角色","icon":"iconfont icon-jiaoseyonghu","Status":1,"RouterPath":"system/admin","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"角色管理","icon":"iconfont icon-jiaoseguanli4","Status":1,"RouterPath":"system/role","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"参数配置","icon":"iconfont icon--shebeicanshu","Status":1,"RouterPath":"system/systemParameter","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"国家管理","icon":"iconfont icon-dc-icon-guojiaqiyejishuzhongxin","Status":1,"RouterPath":"system/country","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"轮播图管理","icon":"iconfont icon-lunbotu","Status":1,"RouterPath":"system/slideshow","Read":0,"Add":0,"Update":0,"Delete":0},{"Name":"时区管理","icon":"iconfont icon-shiqudechuli","Status":1,"RouterPath":"system/timezone","Read":0,"Add":0,"Update":0,"Delete":0}]}]

		let newArr = []

		// console.log("menuEditListArr",menuEditListArr,typeof menuEditListArr)

		menuEditListArr.forEach((item)=>{
			// console.log("item",item)
			if(item.Second){
				let itemsArr = []
				item.Second.forEach((items)=>{
					itemsArr.push({
						"name":items.Name,
						"value":items.RouterPath,
						"checked":items.Read && items.Add && items.Update && items.Delete && items.Name !== '时区管理' ? true:false,
						"disabled":items.Name === '时区管理' ? true:false
					})
				})


				newArr.push({
					"name":item.Name,
					"list":itemsArr,
					// "checked":true,
				})

				newArr.forEach((itemB,index)=>{
					// console.log("itemB",itemB)
					let checkNum = 0
					itemB.list.forEach((itemA,index)=>{
						if(itemA.checked){
							checkNum = checkNum + 1
						}
					})

					if(itemB.list.length === checkNum){
						itemB.checked = true
					}else{
						itemB.checked = false
					}

					// console.log("checkNum",checkNum)
				})


			}

		})

		newArr.unshift({
			"name":"首页",
			"checked":true,
			"disabled":true,
		})
		// console.log("newArr",newArr)

		let getChangeDataJson_checked = {}
		let getChangeDataJson_not_checked = {}
		layui.use(['layer', 'form', 'table', 'util', 'admin', 'xmSelect','notice', 'authtree'], function () {
			var $ = layui.jquery;
			var layer = layui.layer;
			// var layer = parent.layer === undefined ? layui.layer : top.layer;
			var form = layui.form;
			var table = layui.table;
			var util = layui.util;
			var admin = layui.admin;
			var xmSelect = layui.xmSelect;
			var notice = layui.notice;
			var authtree = layui.authtree;

			// 渲染时传入渲染目标ID，树形结构数据（具体结构看样例，checked表示默认选中），以及input表单的名字
			authtree.render('#LAY-auth-tree-index', newArr, {
				inputname: 'ids[]'
				,layfilter: 'lay-check-auth'
				// ,collapseLeafNode:true     //暂时没看出啥作用
				// ,collapseLastDepthNode:true //暂时没看出啥作用
				// ,dblshow: true
				// ,dbltimeout: 180
				// ,autoclose: false
				// ,autochecked: false
				// ,openchecked: false

				,openall: false
				// ,hidechoose: true

				// ,checkType: 'radio'
				// ,checkedKey: 'checked'
				// ,disabledKey: 'disabled'
				// ,checkSkin: 'primary'
				,'theme': 'auth-skin-default'
				,'themePath': '../../assets/module/tree_themes/'
				,autowidth: true
			});
			// 使用 authtree.on() 不会有冒泡延迟
			authtree.on('change(lay-check-auth)', function(data) {
				// console.log('监听 authtree 触发事件数据', data);
				// // 获取所有节点
				// var all = authtree.getAll('#LAY-auth-tree-index');
				// // 获取所有已选中节点
				var checked = authtree.getChecked('#LAY-auth-tree-index');
				// console.log("checked",checked)
				getChangeDataJson_checked = checked
				// 获取所有未选中节点
				var notchecked = authtree.getNotChecked('#LAY-auth-tree-index');
				getChangeDataJson_not_checked = notchecked
				// console.log("notchecked",notchecked)
				// // 获取选中的叶子节点
				// var leaf = authtree.getLeaf('#LAY-auth-tree-index');
				// // 获取最新选中
				// var lastChecked = authtree.getLastChecked('#LAY-auth-tree-index');
				// // 获取最新取消
				// var lastNotChecked = authtree.getLastNotChecked('#LAY-auth-tree-index');
				// console.log(
				// 		'all', all,"\n",
				// 		'checked', checked,"\n",
				// 		'notchecked', notchecked,"\n",
				// 		'leaf', leaf,"\n",
				// 		'lastChecked', lastChecked,"\n",
				// 		'lastNotChecked', lastNotChecked,"\n"
				// );
			});
			authtree.on('deptChange(lay-check-auth)', function(data) {
				// console.log('监听到显示层数改变',data);
			});
			authtree.on('dblclick(lay-check-auth)', function(data) {
				// console.log('监听到双击事件',data);
			});
			// 表单提交样例
			form.on('submit(LAY-auth-tree-submit)', function(obj){
				// var authids = authtree.getChecked('#LAY-auth-tree-index');
				// console.log('Choosed authids is', authids);
				// obj.field.authids = authids;
				// console.log("obj.field",obj.field)

				// let getChangeDataJson = obj.field
				let getChangeDataArr = []

				//修改选中的状态
				Object.keys(getChangeDataJson_checked).forEach((item)=>{
					if(getChangeDataJson_checked[item] && getChangeDataJson_checked[item] != "undefined"){
						let currData = getChangeDataJson_checked[item]
						// console.log("currData",currData)
						menuEditListArr.forEach((mItem)=>{
							if(mItem.Second){
								mItem.Second.forEach((mItem_S)=>{
									if( currData == mItem_S.RouterPath){
										mItem_S.Add = 1
										mItem_S.Delete = 1
										mItem_S.Read = 1
										mItem_S.Update = 1
									}
								})


							}


						})
					}
				})

				//修改未选中的状态
				Object.keys(getChangeDataJson_not_checked).forEach((item)=>{
					if(getChangeDataJson_not_checked[item] && getChangeDataJson_not_checked[item] != "undefined"){
						let currData = getChangeDataJson_not_checked[item]
						menuEditListArr.forEach((mItem)=>{
							if(mItem.Second){
								mItem.Second.forEach((mItem_S)=>{
									if( currData == mItem_S.RouterPath || mItem_S.Name == '时区管理'){
										mItem_S.Add = 0
										mItem_S.Delete = 0
										mItem_S.Read = 0
										mItem_S.Update = 0
									}
								})


							}


						})


					}
				})

				console.log("menuEditListArr",menuEditListArr)
				var param = {};
				param['status'] = 1;
				param['role_name'] = obj.field.role_name;
				param['jurisdiction'] = JSON.stringify(menuEditListArr)
				// console.log("param",param)
				$.ajax({
					url: global_requestAddress+ global_requestAddress_js_role+"?action=add",
					headers:{
						token:mybck
					},
					type: "POST",
					data: param,
					dataType: "json",
					success: function (addResult) {

						if (addResult.code === 2000) {
							notice.msg(addResult.msg, {icon: 1});

							setTimeout(function () {
								window.location.href = "../../login.html";
								var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
								parent.layer.close(index);
								// localStorage.removeItem("menuList");

							}, 1300)

						} else {
							notice.msg(addResult.msg, {icon: 2});
						}


					},


				});






				return false;
			});


			//添加内容点击事件
			$("#comfireAdd").click(function () {
				if($("#money").val() == ""){

					notice.msg("充值金额不能为空", {icon: 2});

					return false

				}
				var param = {};
				param['token'] = $.cookie('tokenMyb');
				param['money'] = $("#money").val();
				param['id'] = currParentDatas.id;
				$.ajax({
					url: js_global_requestAddress_reduce_for_one,
					data: param,
					type: "POST",
					dataType: "json",
					success: function (addResult) {

						if (addResult.code === 200) {
							// layer.msg(addResult.msg);
							notice.msg(addResult.msg, {icon: 1});
							setTimeout(function () {
								var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
								parent.layer.close(index);
								// window.parent.location.reload();
							}, 1300)

						} else {

							// layer.msg(addResult.msg);
							notice.msg(addResult.msg, {icon: 2});
							// setTimeout(function () {
							// 	var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
							// 	parent.layer.close(index);
							// 	// window.parent.location.reload();
							// }, 1300)

						}


					},


				});


				// parent.local.reload();

				return false;
			})


			//添加内容点击事件
			$("#cancelAdd").click(function () {

				// layer.msg("取消操作");
				notice.msg('取消操作!', {icon: 5});
				var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
				parent.layer.close(index);
				// window.parent.location.reload();


				return false;

			})

		})
	}
</script>
</body>
</html>
